---
title: "Textile-Factory"
output:
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Textile-Factory}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height = 5.5,
	fig.width = 6,
	warning = FALSE,
	collapse = TRUE,
	dev.args = list(pointsize = 10),
	out.width = "65%",
	par = TRUE
)
knit_hooks$set(par = function(before, options, envir)
  { if (before && options$fig.show != "none") 
       par(family = "sans", mar = c(4.1,4.1,1.1,1.1), mgp = c(3,1,0), tcl = -0.5)
})
```

```{r, message = FALSE, echo = FALSE}
library(SMM)
```

# Context

Let's introduce a practical example where a semi-Markov modeling is appropriate. 
Let $\mathcal{F}$ be a textile factory. To avoid river pollution, the factory 
waste is treated in the unit \eqn{U} before being thrown in the river 
$\mathcal{R}$. In order for the factory not to be stopped if a failure occurs 
in the treatment unit $\mathcal{U}$, the waste is stocked in a tank $\mathcal{T}$. 
If $\mathcal{U}$ is repaired before $\mathcal{T}$ is full, then the factory starts 
to work again normally and we suppose that the tank is emptied instantaneously 
(before another failure of $\mathcal{U}$). Otherwise, the whole factory has to 
stop and a certain time is necessary to restart it. The figure below describes 
the waste treatment system of the textile factory.

<br />

```{r echo = FALSE, out.width = '400px', fig.cap = 'Waste treatment for a textile factory'}
knitr::include_graphics("Waste_treatment.png")
```

<br />

As the output of the factory is variable, the filling time of the tank is a 
random variable. Moreover, if we suppose that the filling time is deterministic, 
we can still make the assumption that we have a random time that has a Dirac 
distribution.

We propose a semi-Markov modelization for the evolution of the described system. 
Let $E = \{\texttt{"}1\texttt{"},\ \texttt{"}2\texttt{"},\ \texttt{"}3\texttt{"}\}$ 
be the set of possible states of the system, where we set:
 
 * **State 1** - everything is working, that is, $\mathcal{F}$ and $\mathcal{U}$ 
  are in good state and $\mathcal{T}$ is empty;
 * **State 2** - $\mathcal{U}$ has failed, but $\mathcal{T}$ is not yet full, 
  so the factory is still working;
 * **State 3** - $\mathcal{U}$ has failed and $\mathcal{T}$ is full, so the factory 
  is not working.

The possible transitions between states are given in the following figure:

<br />

```{r echo = FALSE, out.width = '400px', fig.cap = 'Three-state discrete-time semi-Markov system modelization'}
knitr::include_graphics("Three_state_modelization.png")
```

<br />
<br />

The system is defined by:

 * The initial distribution $\boldsymbol{\alpha} = (\alpha_1,\ \alpha_2,\ \alpha_3)$;
 
 * The transition matrix $\boldsymbol{p}$ of the embedded Markov chain 
  $(J_n)_{n \in \mathbb{N}}$ 
  $\boldsymbol{p} = \begin{pmatrix} 0 & 1 & 0 \\ a & 0 & b \\ 1 & 0 & 0 \end{pmatrix}$,
  
  * The conditional sojourn time distributions
    $\boldsymbol{f(k)} = \begin{pmatrix} 0 & f_{12}(k) & 0 \\ f_{21}(k) & 0 & f_{23}(k) \\ f_{31}(k) & 0 & 0 \end{pmatrix}, \ k \in \mathbb{N}$,
    
    where,
      
      - $f_{12}$ is the distribution of the failure time of the treatment 
        unit $\mathcal{U}$;
      
      - $f_{21}$ is the distribution of the repairing time of $\mathcal{U}$;

      - $f_{23}$ is the distribution of the filling time of the tank $\mathcal{T}$;
      - $f_{31}$ is the distribution of time needed to restart the entire 
        factory $\mathcal{F}$, after it has been shut down.

This is a irreducible discrete-time Markov renewal system. We chose the 
following sojourn time distributions:

- $f_{12}$ is the geometric distribution on $\mathbb{N}^{*}$ of parameter $p$, 
  $0 < p < 1$, i.e., $f_{12}(k) = p(1 - p)^{k - 1},\ k \in \mathbb{N}^{*}$.
  
- $f_{21} = W_{q1, b1},\ f_{23} = W_{q2, b2},\ f_{31} = W_{q3, b3}$ are 
  discrete-time first-type Weibull distributions, defined by:
    $$W_{q, b}(0) = 0,\ W_{q, b}(k) = q^{(k - 1)^{b}} - q^{k^{b}},\ k \in \mathbb{N}^{*}$$

The choice of discrete-time Weibull distribution is motivated by its use in 
reliability theory. In fact, our main purpose is to compute and estimate the 
main reliability indicators of this system.

<br />





# Numerical application

Let us continue the example of the textile factory presented above. We take the
initial distribution $\boldsymbol{\alpha} = (1,\ 0,\ 0)$, the transition matrix
of the embedded Markov chain $(J_{n})_{n \in \mathbb{N}}$,
$$ \boldsymbol{p} = \begin{pmatrix} 0 & 1 & 0 \\ 0.95 & 0 & 0.05 \\ 1 & 0 & 0 \end{pmatrix} $$
and the following conditional sojourn time distributions:

- $f_{12}$ is the geometric distribution on $\mathbb{N}^{*}$ with parameter $p = 0.8$;

- $f_{21} = W_{q1, b1},\ f_{23} = W_{q2, b2},\ f_{31} = W_{q3, b3}$ are 
  discrete-time Weibull distributions with parameters:
      $$ q_{1} = 0.3,\ b_{1} = 0.5,\ q_{2} = 0.5,\ b_{2} = 0.7,\ q_{3} = 0.6,\ b_{3} = 0.9.$$
      



## Specification and simulation

First, let's create a **smmparametric** object to represent the Semi Markov 
chain associated to the system:

```{r}
states <- c("1", "2", "3") # State space

alpha <- c(1, 0, 0) # Initial distribution

p <- matrix(data = c(0, 1, 0, 
                     0.95, 0, 0.05, 
                     1, 0, 0), nrow = 3, byrow = TRUE) # Transition matrix

distr <- matrix(c(NA, "geom", NA, 
                  "dweibull", NA, "dweibull", 
                  "dweibull", NA, NA), 
                nrow = 3, ncol = 3, byrow = TRUE) # Distribution matrix

param1 <- matrix(c(NA, 0.8, NA, 
                   0.3, NA, 0.5,
                   0.6, NA, NA), 
                 nrow = 3, ncol = 3, byrow = TRUE)

param2 <- matrix(c(NA, NA, NA, 
                   0.5, NA, 0.7,
                   0.9, NA, NA), 
                 nrow = 3, ncol = 3, byrow = TRUE)

parameters <- array(c(param1, param2), c(3, 3, 2))

factory <- smmparametric(states = states, init = alpha, ptrans = p, 
                         type.sojourn = "fij", distr = distr, param = parameters)
```

After that, we are able to simulate a sequence of sample sizes $M = 10000$:

```{r}
M <- 10000
seq <- simulate(object = factory, nsim = M)
```




## Estimation

Thanks to the **SMM** package, we can estimate any Semi-Markov model with one 
or several discrete sequences. In our case, we are going to introduce a 
**parametric estimation**:

```{r}
estimate <- fitsemimarkovmodel(sequences = seq, states = states, 
                          type.sojourn = "fij", distr = distr)
```

The estimate $\hat{p}$ of the transition matrix $p$ is:

```{r}
print(x = estimate$ptrans, digits = 2)
```

The estimates of the parameters are:

```{r}
print(x = estimate$param, digits = 2)
```

In the following sections, based on the estimated model, we are going to 
compute some quantities/indicators such as the reliability, the availability...


## Reliability

Consider a system $S_{ystem}$ starting to function at time $k = 0$. The 
**reliability** of $S_{ystem}$ at time $k \in \mathbb{N}$ is the probability 
that the system has functioned without failure in the period $[0, k]$. Let's 
take $k = 100$.

```{r}
k <- 300
upstates <- c("1", "2") # Working states of the semi-Markov system
reliab <- reliability(x = factory, k = k, alpha = c(1, 0), upstates = upstates)
```

```{r}
plot(x = 0:k, y = reliab, pch = ".", cex = 2.5, ylim = c(0, 1), 
     col = "blue", xlab = "time", ylab = "reliability")
```




## Availability

The pointwise (or instantaneous) **availability** of a system $S_{ystem}$ at 
time $k \in \mathbb{N}$ is the probability that the system is operational at 
time $k$ (independently of the fact that the system has failed or not in 
$[0, k)$).

```{r}
avail <- availability(x = factory, k = k, alpha = alpha, upstates = upstates)
```

```{r}
plot(x = 0:k, y = avail, pch = ".", cex = 2.5, ylim = c(0.95, 1), 
     col = "blue", xlab = "time", ylab = "availability")
```




## Maintainability

For a reparable system $S_{ystem}$ for which the failure occurs at time 
$k = 0$, its **maintainability** at time $k \in \mathbb{N}$ is the probability 
that the system is repaired up to time $k$, given that it has failed at time 
$k = 0$.

```{r}
downstates <- c("3") # Failure state of the semi-Markov system
maintain <- maintainability(x = factory, k = 300, alpha = c(1), downstates = c("3"))
```

```{r}
plot(x = 0:k, y = maintain, pch = ".", cex = 2.5, ylim = c(0, 1), 
     col = "blue", xlab = "time", ylab = "maintainability")
```




## Failure Rates



### BMP-Failure Rate

Consider a system $S_{ystem}$ starting to work at time $k = 0$. The 
**BMP-failure rate** at time $k \in \mathbb{N}$ is the conditional probability 
that the failure of the system occurs at time $k$, given that the system has 
worked until time $k - 1$.

```{r}
failureBMP <- failureRateBMP(x = factory, k = k, alpha = c(1, 0), upstates = upstates)
```

```{r}
plot(x = 0:k, y =  failureBMP, pch = ".", cex = 2.5, ylim = range(failureBMP), 
     col = "blue", xlab = "time", ylab = "BMP Failure Rate")
```



### RG-Failure Rate

Discrete-time adapted failure rate, proposed by Roy and Gupta (1992). We call 
it the **RG-failure rate** and denote it by $r(k),\ k \in \mathbb{N}$.

```{r}
failureRG <- failureRateRG(x = factory, k = k, alpha = c(1, 0), upstates = upstates)
```

```{r}
plot(x = 0:k, y =  failureRG, pch = ".", cex = 2.5, ylim = c(0, 0.02), 
     col = "blue", xlab = "time", ylab = "RG Failure Rate")
```




## Mean Times



### Mean Time To Failure (MTTF)

Consider a system $S_{ystem}$ starting to work at time $k = 0$. 
The **mean time to failure** (MTTF) is defined as the mean lifetime.

```{r}
mttf(x = factory, alpha = c(1, 0), upstates = upstates)
```



### Mean Time To Repair (MTTR)

Consider a system $S_{ystem}$ starting to fail at time $k = 0$. The 
**mean time to repair (MTTR)** is defined as the mean of the repair duration.

```{r}
mttr(x = factory, alpha = c(1), downstates = downstates)
```